<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <title>Scan QR - Absensi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- QR Scanner -->
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="w-full max-w-xl p-6 bg-white rounded-lg shadow-lg">
        <h2 id="infoJenis" class="text-xl font-semibold text-gray-800 mb-4 text-center"></h2>

        <!-- Input Keterangan untuk Izin -->
        <div id="keteranganForm" class="mb-4 text-center hidden">
            <label for="keterangan" class="block text-gray-700 font-semibold mb-2">Keterangan Izin</label>
            <textarea id="keterangan" rows="3"
                class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-400"
                placeholder="Input Keterangan"></textarea>

            <!-- Input file hanya ditampilkan jika jenis adalah "Tidak Masuk" -->
            <div id="fileUploadContainer" class="mt-3 hidden">
                <label for="suratIzin" class="block text-gray-700 font-semibold mb-2">Upload Surat Izin</label>
                <input type="file" id="suratIzin"
                    class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-400"
                    accept=".jpg,.jpeg,.png,.pdf" />
            </div>

            <button id="mulaiScanBtn"
                class="mt-3 px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition">
                Lanjut Scan QR
            </button>
        </div>


        <!-- Scanner -->
        <div id="reader" class="w-full hidden"></div>

        <!-- Tombol Batal -->
        <div class="mt-4 text-center">
            <button onclick="window.location.href='dashboard.html'"
                class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition duration-200">
                <i class="fas fa-arrow-left mr-1"></i> Batal & Kembali ke Dashboard
            </button>
        </div>

        <!-- Hasil Scan -->
        <div id="scanResult" class="mt-4 text-center text-gray-700 font-medium"></div>
    </div>

    <script>
        const ABSEN_URL = "https://script.google.com/macros/s/AKfycbyPpxuE_WI-gK5oymZv-w8PS1fGsp-B8B1S2UugC1lE1PWBBZ_PaYYTVK8MzzXYosjV4g/exec";

        const user = JSON.parse(sessionStorage.getItem("user"));
        const jenis = sessionStorage.getItem("absenJenis");

        if (!user || !jenis) {
            window.location.href = "index.html";
        }

        document.getElementById("infoJenis").innerText =
            `Silakan ${jenis === "Tidak Masuk" ? "Isi Keterangan & Upload Surat" : "Scan QR"} untuk Absen ${jenis}`;

        const reader = document.getElementById("reader");
        const formIzin = document.getElementById("keteranganForm");
        const mulaiScanBtn = document.getElementById("mulaiScanBtn");
        const fileInput = document.getElementById("suratIzin");

        if (jenis === "Izin" || jenis === "Tidak Masuk") {
            formIzin.classList.remove("hidden");
            mulaiScanBtn.textContent = "Kirim";

            const fileContainer = document.getElementById("fileUploadContainer");
            if (jenis === "Tidak Masuk") {
                fileContainer.classList.remove("hidden");
            } else {
                fileContainer.classList.add("hidden");
            }


            mulaiScanBtn.addEventListener("click", async () => {
                const ket = document.getElementById("keterangan").value.trim();
                const file = fileInput.files[0];

                if (ket === "") {
                    Swal.fire({ icon: "warning", title: "Keterangan kosong", text: "Silakan isi keterangan terlebih dahulu." });
                    return;
                }

                if (jenis === "Tidak Masuk") {
                    if (!file) {
                        Swal.fire({ icon: "warning", title: "File belum dipilih", text: "Silakan unggah surat izin terlebih dahulu." });
                        return;
                    }

                    try {
                        const base64Data = await toBase64(file);
                        const linkSurat = await uploadSurat(base64Data, file.name);
                        kirimAbsen("", ket, linkSurat); // âœ… sekarang sudah mengirim link yang benar
                    } catch (error) {
                        console.error("Gagal upload surat:", error);
                    }
                } else {
                    // Jenis Izin, simpan keterangan lalu lanjut QR
                    user.Keterangan = ket;
                    formIzin.classList.add("hidden");
                    reader.classList.remove("hidden");
                    startScanner();
                }
            });

        } else {
            reader.classList.remove("hidden");
            startScanner();
        }

        function startScanner() {
            const html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 }, false);
            html5QrcodeScanner.render((decodedText) => {
                html5QrcodeScanner.clear();
                document.getElementById("scanResult").innerHTML = `<div class="text-blue-500">Memproses absensi...</div>`;
                kirimAbsen(decodedText, user.Keterangan || "");
            });
        }

        function kirimAbsen(kodeQR, keterangan, linkSurat = "") {
            const formData = new FormData();
            formData.append("action", "absen");
            formData.append("id", user.Id);
            formData.append("nama", user.Nama);
            formData.append("nip", user.NIP);
            formData.append("jenis", jenis);
            formData.append("kodeQR", kodeQR);
            formData.append("keterangan", keterangan);
            formData.append("link", linkSurat);

            fetch(ABSEN_URL, {
                method: "POST",
                body: formData,
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status) {
                        Swal.fire({ icon: "success", title: "Berhasil!", text: data.message, timer: 3000, showConfirmButton: false });
                        setTimeout(() => { window.location.href = "dashboard.html"; }, 3000);
                    } else {
                        Swal.fire({ icon: "error", title: "Gagal!", text: data.message }).then(() => {
                            window.location.href = "dashboard.html";
                        });
                    }
                })
                .catch(() => {
                    Swal.fire({ icon: "error", title: "Gagal", text: "Tidak dapat menghubungi server." }).then(() => {
                        window.location.href = "dashboard.html";
                    });
                });
        }


        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64 = reader.result.split(",")[1];
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
            });
        }

        async function uploadSurat(base64Data, filename) {
            const res = await fetch(ABSEN_URL, {
                method: "POST",
                body: new URLSearchParams({
                    action: "uploadSurat",
                    filedata: base64Data,
                    filename: "Surat_" + user.Nama + "_" + new Date().toISOString() + "_" + filename,
                    nama: user.Nama
                }),
            });

            const data = await res.json();
            if (!data.status) {
                Swal.fire({ icon: "error", title: "Upload Gagal", text: data.message });
                throw new Error("Upload gagal");
            }
            return data.link; // pastikan Apps Script mengirim 'link'
        }


    </script>


</body>

</html>
